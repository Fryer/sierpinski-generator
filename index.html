<!doctype html>
<html>
<head>
<title>Sierpinski Generator</title>
<meta charset="utf-8">
<style>

*
{
	font-family: sans-serif;
	font-size: 10pt;
}
html
{
	background: #202020;
	color: #9fafbf;
	line-height: 1.5;
}
body
{
	margin: 10px 20px;
}
.gui
{
	background: #181818;
	display: inline-block;
	vertical-align: top;
	margin-right: 20px;
	width: 300px;
	height: 900px;
	box-sizing: border-box;
	padding: 5px 15px;
	overflow-y: scroll;
}
h1, h2
{
	margin: 0 0 5px 5px;
}
h1
{
	font-size: 18pt;
}
h2
{
	font-size: 12pt;
	font-weight: bold;
	margin-top: 15px;
}
table
{
	border-spacing: 0;
}
td
{
	padding: 0;
}
td:first-child
{
	padding-right: 10px;
}
button
{
	cursor: pointer;
	background: #303030;
	color: #9fbf9f;
	border: 1px solid #60707f;
	margin: 0 5px 5px 0;
	padding: 1px 10px;
}
button:hover
{
	background: #506050;
	border-color: #9fbf9f;
}
input, select, textarea
{
	background: #101010;
	color: #9fbf9f;
	border: 1px solid #60707f;
	margin-bottom: 2px;
	padding: 1px 2px;
}
textarea
{
	font-family: monospace;
	resize: none;
}
code
{
	background: #141414;
	color: #bfbfbf;
	border: 1px solid #303030;
	font-family: monospace;
}
canvas
{
	height: 900px;
}

</style>
</head>
<body>
<div class="gui">

<h1>Sierpinski Generator</h1>

<button onclick="start()">Start</button> <button onclick="stop()">Stop</button> <button onclick="reset()">Reset</button>
<table><tbody>
	<tr><td><label for="preset">Preset:</label></td><td><select id="preset" onchange="loadPreset(this.value)">
		<option value="eyJ3aWR0aCI6IjkwMCIsImhlaWdodCI6IjkwMCIsInJhdGUiOiIxMDAwIiwic3RvcEF0IjoiMCIsIngiOiIwIiwieSI6IjAiLCJ6b29tIjoiMSIsImxlcnAiOiIuNSIsImJhY2tncm91bmQiOiIjMTAxMDEwIiwiY29sb3IiOiIjZmZiZjdmIiwiYWxwaGEiOiIuMSIsInBvaW50cyI6IltbMCwgMF1dIiwibGVycE92ZXJyaWRlIjoiIiwiZHJhd092ZXJyaWRlIjoiIn0=">Initial (empty)</option>
		<optgroup label="Simple">
			<option value="eyJ3aWR0aCI6IjkwMCIsImhlaWdodCI6IjkwMCIsInJhdGUiOiIxMDAwIiwic3RvcEF0IjoiMCIsIngiOiIwIiwieSI6IjAiLCJ6b29tIjoiMSIsImxlcnAiOiIuNSIsImJhY2tncm91bmQiOiIjMTAxMDEwIiwiY29sb3IiOiIjZmZiZjdmIiwiYWxwaGEiOiIuMSIsInBvaW50cyI6IltbMCwgICAtLjVdLFxuIFstLjUsIC41XSxcbiBbLjUsICAuNV1dIiwibGVycE92ZXJyaWRlIjoiIiwiZHJhd092ZXJyaWRlIjoiIn0=">Sierpinski Triangle</option>
		</optgroup>
		<optgroup label="Colorful">
			<option value="eyJ3aWR0aCI6IjM2MDAiLCJoZWlnaHQiOiIzNjAwIiwicmF0ZSI6IjEwMDAwIiwic3RvcEF0IjoiMCIsIngiOiIwIiwieSI6IjAiLCJ6b29tIjoiMi8zIiwibGVycCI6Ii41IiwiYmFja2dyb3VuZCI6IiMxMDEwMTAiLCJjb2xvciI6IiNmZmJmN2YiLCJhbHBoYSI6Ii4xIiwicG9pbnRzIjoiW1stLjI1LCAtLjI1LCAnI2ZmN2YwMCddLFxuIFsuMjUsICAtLjI1LCAnI2ZmN2YwMCddLFxuIFstLjI1LCAuMjUsICAnI2ZmN2YwMCddLFxuIFsuMjUsICAuMjUsICAnI2ZmN2YwMCddLFxuIFswLCAgICAtMS82LCAnIzAwN2ZmZiddLFxuIFswLCAgICAxLzYsICAnIzAwN2ZmZiddLFxuIFstMS82LCAwLCAgICAnIzAwN2ZmZiddLFxuIFsxLzYsICAwLCAgICAnIzAwN2ZmZiddLFxuIFswLCAgICAwLCAgICAnIzAwYmYwMCddXSIsImxlcnBPdmVycmlkZSI6ImwgPSAyIC8gKDEgKyBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSkgKiAuNSk7IiwiZHJhd092ZXJyaWRlIjoiZHJhdyhkeCwgZHkpO1xuaWYgKGRjICE9IGNvbG9yKSB7XG4gIGNvbG9yID0gZGM7XG4gIGRyYXcoZHgsIGR5KTtcbn0ifQ==" selected>Bubble Flower</option>
		</optgroup>
	</select></td></tr>
	<tr><td><label for="width">Size:</label></td><td><input id="width" value="3600" size="5"><label for="height">x</label><input id="height" value="3600" size="5"></td></tr>
	<tr><td><label for="rate">Rate:</label></td><td><input id="rate" name="rate" value="10000" size="5"></td></tr>
	<tr><td><label for="stopAt">Stop at:</label></td><td><input id="stopAt" name="stopAt" value="0" size="5"> (0 = endless)</td></tr>
</tbody></table>

<h2>Transform:</h2>
<table><tbody>
	<tr><td><label for="x">Offset:</label></td><td><input id="x" name="offsetX" value="0" size="5"><label for="y">, </label><input id="y" name="offsetY" value="0" size="5"></td></tr>
	<tr><td><label for="zoom">Zoom:</label></td><td><input id="zoom" name="zoom" value="2/3" size="5"></td></tr>
</tbody></table>

<h2>Options:</h2>
<table><tbody>
	<tr><td><label for="lerp">Lerp: </label></td><td><input id="lerp" name="lerp" value=".5" size="5"></td></tr>
	<tr><td><label for="background">Background color:</label></td><td><input id="background" value="#101010" size="5"></td></tr>
	<tr><td><label for="color">Dot color:</label></td><td><input id="color" value="#ffbf7f" size="5"></td></tr>
	<tr><td><label for="alpha">Dot alpha:</label></td><td><input id="alpha" name="defaultAlpha" value=".1" size="5"></td></tr>
</tbody></table>

<h2>Points:</h2>
<textarea id="points" name="points" cols="32" rows="10">
[[-.25, -.25, '#ff7f00'],
 [.25,  -.25, '#ff7f00'],
 [-.25, .25,  '#ff7f00'],
 [.25,  .25,  '#ff7f00'],
 [0,    -1/6, '#007fff'],
 [0,    1/6,  '#007fff'],
 [-1/6, 0,    '#007fff'],
 [1/6,  0,    '#007fff'],
 [0,    0,    '#00bf00']]</textarea><br>
Format: <code>[[x, y, color, alpha], ...]</code>

<h2>Override lerp code:</h2>
<textarea id="lerpOverride" cols="32" rows="4" placeholder="l = lerp;">
l = 2 / (1 + Math.sqrt(x * x + y * y) * .5);</textarea><br>
Lerp: <code>lerp</code><br>
Last dot x, y: <code>x, y</code><br>
Point x, y: <code>nx, ny</code><br>
Modified lerp: <code>l</code>

<h2>Override draw code:</h2>
<textarea id="drawOverride" cols="32" rows="6" placeholder="color = dc;
alpha = da;
draw(dx, dy);">
draw(dx, dy);
if (dc != color) {
  color = dc;
  draw(dx, dy);
}</textarea><br>
Dot x, y, color, alpha: <code>dx, dy, dc, da</code><br>
Draw color, alpha: <code>color, alpha</code><br>
Draw dot: <code>draw(x, y)</code>

</div>
<canvas id="canvas" width="3600" height="3600"></canvas>
<script>

canvas = document.getElementById('canvas');
c = canvas.getContext('2d');


function loadPreset(preset)
{
	// Print current config to dev console.
	var data = {};
	var configs = document.querySelectorAll('.gui [id]:not([id=preset])');
	for (var config of configs)
	{
		data[config.id] = config.value;
	}
	console.log(btoa(JSON.stringify(data)));
	
	data = JSON.parse(atob(preset));
	for (var [id, value] of Object.entries(data))
	{
		document.getElementById(id).value = value;
	}
}


function readConfig()
{
	var configs = document.querySelectorAll('.gui [name]');
	for (var config of configs)
	{
		window[config.name] = eval(config.value);
	}
	
	canvas.width = document.getElementById('width').value;
	canvas.height = document.getElementById('height').value;
	background = document.getElementById('background').value;
	defaultColor = document.getElementById('color').value;
	
	lerpOverride = document.getElementById('lerpOverride').value;
	if (lerpOverride)
	{
		lerpOverride = new Function('nx', 'ny', 'var l;' + lerpOverride + 'return l;');
	}
	drawOverride = document.getElementById('drawOverride').value;
	if (drawOverride)
	{
		drawOverride = new Function('dx', 'dy', 'dc', 'da', drawOverride);
	}
}


function start()
{
	reset();
	
	color = defaultColor;
	alpha = defaultAlpha;
	x = 0;
	y = 0;
	
	frameId = requestAnimationFrame(frame);
}

function stop()
{
	if (frameId)
	{
		cancelAnimationFrame(frameId);
		frameId = 0;
	}
	frameIndex = 0;
}

function reset()
{
	stop();
	readConfig();
	
	c.fillStyle = background;
	c.globalAlpha = 1;
	c.fillRect(0, 0, canvas.width, canvas.height);
}

frameId = 0;
reset();


function draw(dx, dy)
{
	c.fillStyle = color;
	c.globalAlpha = alpha;
	c.fillRect(dx * canvas.width, dy * canvas.height, 1, 1);
}

function step()
{
	for (i = 0; i < rate; i++)
	{
		var n = Math.min(Math.floor(Math.random() * points.length), points.length - 1);
		
		var nx = points[n][0];
		var ny = points[n][1];
		var l = lerpOverride ? lerpOverride(nx, ny) : lerp;
		x = x * (1 - l) + nx * l;
		y = y * (1 - l) + ny * l;
		
		var dx = (x - offsetX) * zoom + .5;
		var dy = (y - offsetY) * zoom + .5;
		var dc = points[n][2] ? points[n][2] : defaultColor;
		var da = points[n][3] ? points[n][3] : defaultAlpha;
		if (drawOverride)
		{
			drawOverride(dx, dy, dc, da);
			continue;
		}
		color = dc;
		alpha = da;
		draw(dx, dy);
	}
}

function frame()
{
	frameIndex++;
	if (stopAt == 0 || frameIndex < stopAt)
	{
		frameId = requestAnimationFrame(frame);
	}
	
	step();
}

</script>
</body>
</html>